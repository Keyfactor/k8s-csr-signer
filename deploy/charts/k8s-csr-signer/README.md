<a href="https://kubernetes.io">
    <img src="https://kubernetes.io/images/favicon.png" alt="Kubernetes logo" title="K8s" align="left" height="50" />
</a>

<a href="https://kubernetes.io">
    <img src="https://helm.sh/img/helm.svg" alt="Helm logo" title="K8s" align="left" height="50" />
</a>

# Helm chart for the Command K8s Certificate Signing Request Proxy

[![Go Report Card](https://goreportcard.com/badge/github.com/Keyfactor/k8s-csr-signer)](https://goreportcard.com/report/github.com/Keyfactor/k8s-csr-signer) [![GitHub tag (latest SemVer)](https://img.shields.io/github/v/tag/keyfactor/k8s-csr-signer?label=release)](https://github.com/keyfactor/k8s-csr-signer/releases) ![Type: application](https://img.shields.io/badge/Type-application-informational?style=flat-square) [![license](https://img.shields.io/github/license/keyfactor/k8s-csr-signer.svg)]()

The Command Certificate Signing Request Proxy for K8s forwards certificate signing requests generated by Kubernetes to [Keyfactor Command](https://www.keyfactor.com/products/command/) for signing by a trusted enterprise certificate authority. The signer operates within the [K8s CertificateSigningRequests API](https://kubernetes.io/docs/reference/access-authn-authz/certificate-signing-requests/) and implements a Controller that uses the the V1 CertificateSigningRequests API to handle associated resources. CSRs are only enrolled if they are approved using an [approver](https://github.com/kubernetes/kubernetes/tree/master/pkg/controller/certificates/approver).

## Installation

### Add Helm Repository

```bash
helm repo add command-k8s https://keyfactor.github.io/k8s-csr-signer
helm repo update
```

### Install Chart

```bash
helm install k8s-csr-signer command-issuer/k8s-csr-signer \
    --namespace command-signer-system \
    --set image.repository=<your container registry>/keyfactor/k8s-csr-signer \
    --set image.tag=<tag> \
    # --set image.pullPolicy=Never # Only required if using a local image \
    --set image.pullPolicy=Never \
    --set command.credsSecretName=command-credentials \
    --set command.configMapName=command-signer-config \
    # --set command.caCertConfigmapName=command-ca-cert # Only required if Command API serves an untrusted certificate
```

Modifications can be made by overriding the default values in the `values.yaml` file with the `--set` flag. For example, to override the `replicaCount` value, run the following command:
```shell
helm install k8s-csr-signer command-k8s/k8s-csr-signer \
    --namespace command-signer-system \
    --set image.repository=<your container registry>/keyfactor/k8s-csr-signer \
    --set image.tag=<tag> \
    --set command.credsSecretName=command-credentials \
    --set command.configMapName=command-signer-config \
    --set command.signerNames[0]=internalsigner.com
```

Modifications can also be made by modifying the `values.yaml` file directly. For example, to override the
`signerNames` value, modify the `signerNames` value in the `values.yaml` file:

```yaml
cat <<EOF > override.yaml
image:
    repository: <your container registry>/keyfactor/k8s-csr-signer
    pullPolicy: Never
    tag: "latest"
command:
    credsSecretName: command-credentials
    configMapName: command-signer-config
    caCertConfigmapName: command-ca-cert
    signerNames:
        - internalsigner.com/cluster
EOF
```

Then, use the `-f` flag to specify the `values.yaml` file:

```yaml
helm install k8s-csr-signer command-k8s/k8s-csr-signer \
    -n command-signer-system \
    -f override.yaml
```

###### :pushpin: Wildcards are **NOT** supported in the `signerNames` field. If you want to allow all signers, do not specify any signer names.

###### :pushpin: The Command K8s CSR signer uses the `SelfSubjectAccessReview` API to determine if the user has permission to sign the CSR. If the user does not have permission, the signer will ignore the CSR.

## Configuration

The following table lists the configurable parameters of the `k8s-csr-signer` chart and their default values.

| Configuration Item            | Default Value   | Description                                                     |
|-------------------------------|-----------------|-----------------------------------------------------------------|
| `replicaCount`                | `1`             | Number of replicas                                              |
| `imagePullSecrets`            | `[]`            | List of secrets used to pull images                             |
| `nameOverride`                | `""`            | Override for the app name                                       |
| `fullnameOverride`            | `""`            | Override for the app's full name                                |
| `image.repository`            | `""`            | Image repository                                                |
| `image.tag`                   | `""`            | Image tag                                                       |
| `image.pullPolicy`            | `IfNotPresent`  | Image pull policy                                               |
| `command.credsSecretName`     | `""`            | Name of the secret containing Command credentials               |
| `command.configMapName`       | `""`            | Name of the configmap containing Command configuration          |
| `command.caCertConfigmapName` | `""`            | Name of the configmap containing the Command API CA certificate |
| `command.signerNames`         | `[]`            | Signer names that this signer will respond to                   |
| `serviceAccount.create`       | `true`          | Specifies whether a service account should be created           |
| `serviceAccount.annotations`  | `{}`            | Annotations to add to the service account                       |
| `serviceAccount.name`         | `"command-k8s"` | The name of the service account to use                          |
| `podSecurityContext`          | `{}`            | Pod security context settings                                   |
| `securityContext`             | `{}`            | Security context settings for the pod                           |
| `resources`                   | `{}`            | CPU/memory resource requests/limits (commented out by default)  |
| `nodeSelector`                | `{}`            | Node labels for pod assignment                                  |
| `tolerations`                 | `[]`            | Tolerations for pod assignment                                  |
| `affinity`                    | `{}`            | Affinity settings for pod assignment                            |

